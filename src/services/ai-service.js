const OpenAI = require('openai');
const { cleanAIResponse, formatForTelegram } = require('../utils/text-cleaner');

class AIService {
  constructor() {
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY
    });
  }

  async getMoodRecommendation(mood, oils, keywords = []) {
    try {
      const oilsText = oils.map(oil => 
        `${oil.oil_name}: ${oil.emotional_effect}`
      ).join('\n');

      const prompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–∏–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç —ç—Ñ–∏—Ä–Ω—ã–µ –º–∞—Å–ª–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è: "${mood}".
      
–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Å–ª–∞:
${oilsText}

–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: ${keywords.join(', ')}

–î–∞–π –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É 2-3 –º–∞—Å–µ–ª. –í–∫–ª—é—á–∏:
- –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –º–∞—Å–ª–∞ –ø–æ–¥—Ö–æ–¥—è—Ç
- –ö–∞–∫ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- –ú–µ—Ä—ã –ø—Ä–µ–¥–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏
- –ù–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)

–í–ê–ñ–ù–û: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏ (###, ##, #, ####) –≤ –æ—Ç–≤–µ—Ç–µ. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º —Å —ç–º–æ–¥–∑–∏.
–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç.

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º.`;

      const response = await this.openai.chat.completions.create({
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–∏–∏ –∏ —ç—Ñ–∏—Ä–Ω—ã–º –º–∞—Å–ª–∞–º. –î–∞–µ—à—å –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏ –∏–ª–∏ markdown –≤ –æ—Ç–≤–µ—Ç–∞—Ö. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º —Å —ç–º–æ–¥–∑–∏."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        max_tokens: 1000,
        temperature: 0.7
      });

      const rawResponse = response.choices[0].message.content;
      return cleanAIResponse(rawResponse);
    } catch (error) {
      console.error('Error getting mood recommendation:', error);
      return `üåø –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è: "${mood}"

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:

‚Ä¢ –õ–∞–≤–∞–Ω–¥–∞ - –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è
‚Ä¢ –ú—è—Ç–∞ - –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏ –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏  
‚Ä¢ –õ–∏–º–æ–Ω - –¥–ª—è –ø–æ–¥–Ω—è—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
‚Ä¢ –≠–≤–∫–∞–ª–∏–ø—Ç - –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏ —É–º–∞

üí° –ù–∞–ø–∏—à–∏—Ç–µ —Ç–æ—á–Ω–µ–µ, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç, –∏ —è –¥–∞–º –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã!`;
    }
  }

  async getMusicRecommendation(request) {
    try {
      const prompt = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: "${request.originalText}"

–î–∞–π 3-5 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –º—É–∑—ã–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–∏–∏ –∏ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è. –í–∫–ª—é—á–∏:
- –ù–∞–∑–≤–∞–Ω–∏—è —Ç—Ä–µ–∫–æ–≤/–∞–ª—å–±–æ–º–æ–≤
- –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
- –ñ–∞–Ω—Ä—ã
- –ü–æ—á–µ–º—É —ç—Ç–∞ –º—É–∑—ã–∫–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç

–í–ê–ñ–ù–û: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏ (###, ##, #, ####) –≤ –æ—Ç–≤–µ—Ç–µ. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º —Å —ç–º–æ–¥–∑–∏.
–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç.

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º.`;

      const response = await this.openai.chat.completions.create({
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º—É–∑—ã–∫–µ –¥–ª—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏ –∏ –∞—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–∏–∏. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏ –∏–ª–∏ markdown –≤ –æ—Ç–≤–µ—Ç–∞—Ö. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º —Å —ç–º–æ–¥–∑–∏."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        max_tokens: 800,
        temperature: 0.8
      });

      const rawResponse = response.choices[0].message.content;
      return cleanAIResponse(rawResponse);
    } catch (error) {
      console.error('Error getting music recommendation:', error);
      return `üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–ª–∏—á–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è:

üéß –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º—É–∑—ã–∫–∞:
‚Ä¢ Debussy - "Clair de Lune"
‚Ä¢ Chopin - "Nocturnes"

üéß Ambient/–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞:
‚Ä¢ Brian Eno - "Music for Airports"
‚Ä¢ Tycho - "Dive"

üéß –ü—Ä–∏—Ä–æ–¥–Ω—ã–µ –∑–≤—É–∫–∏:
‚Ä¢ –ó–≤—É–∫–∏ –¥–æ–∂–¥—è
‚Ä¢ –û–∫–µ–∞–Ω—Å–∫–∏–µ –≤–æ–ª–Ω—ã
‚Ä¢ –õ–µ—Å–Ω—ã–µ –ø—Ç–∏—Ü—ã

üí° –í–∫–ª—é—á–∏—Ç–µ –ª—é–±–∏–º—É—é –º—É–∑—ã–∫—É –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –∞—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–∏–µ–π!`;
    }
  }

  async getHealthRecommendation(issue, oils, keywords = []) {
    try {
      const oilsText = oils.map(oil => 
        `${oil.oil_name}: ${oil.physical_effect}`
      ).join('\n');

      const prompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–∏–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É: "${issue}".
      
–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Å–ª–∞:
${oilsText}

–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: ${keywords.join(', ')}

–î–∞–π –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —ç—Ñ–∏—Ä–Ω—ã—Ö –º–∞—Å–µ–ª. –í–∫–ª—é—á–∏:
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–∞—Å–ª–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã
- –°–ø–æ—Å–æ–±—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å —Ç–æ—á–Ω—ã–º–∏ –¥–æ–∑–∏—Ä–æ–≤–∫–∞–º–∏
- –ú–µ—Ä—ã –ø—Ä–µ–¥–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏
- –ö–æ–≥–¥–∞ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É

–í–ê–ñ–ù–û: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏ (###, ##, #, ####) –≤ –æ—Ç–≤–µ—Ç–µ. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º —Å —ç–º–æ–¥–∑–∏.
–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç.

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º.`;

      const response = await this.openai.chat.completions.create({
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–∏–∏. –î–∞–µ—à—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏ –∏–ª–∏ markdown –≤ –æ—Ç–≤–µ—Ç–∞—Ö. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º —Å —ç–º–æ–¥–∑–∏."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        max_tokens: 1200,
        temperature: 0.6
      });

      const rawResponse = response.choices[0].message.content;
      return cleanAIResponse(rawResponse);
    } catch (error) {
      console.error('Error getting health recommendation:', error);
      return `üåø –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è: "${issue}"

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. 

‚ö†Ô∏è –í–∞–∂–Ω–æ: –ü—Ä–∏ —Å–µ—Ä—å–µ–∑–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–∞—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É!

üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Å–ª–∞:
‚Ä¢ –≠–≤–∫–∞–ª–∏–ø—Ç - –¥–ª—è –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
‚Ä¢ –õ–∞–≤–∞–Ω–¥–∞ - –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è
‚Ä¢ –ú—è—Ç–∞ - –¥–ª—è –≥–æ–ª–æ–≤–Ω–æ–π –±–æ–ª–∏
‚Ä¢ –ß–∞–π–Ω–æ–µ –¥–µ—Ä–µ–≤–æ - –¥–ª—è –∞–Ω—Ç–∏—Å–µ–ø—Ç–∏—á–µ—Å–∫–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞`;
    }
  }
}

module.exports = AIService; 